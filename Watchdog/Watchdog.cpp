#include <windows.h>
#include <string>

#define SVCNAME L"MTUCI_AntimalwareService"

int APIENTRY wWinMain(_In_ HINSTANCE hInstance,
	_In_opt_ HINSTANCE hPrevInstance,
	_In_ LPWSTR    lpCmdLine,
	_In_ int       nCmdShow) {
	SERVICE_STATUS_PROCESS status;
	DWORD dwBytesNeeded;

	SC_HANDLE hScm = OpenSCManagerW(nullptr, nullptr, NULL);
	SC_HANDLE hService = OpenServiceW(hScm, SVCNAME, SERVICE_QUERY_STATUS | SERVICE_START);

	while (true) {
		if (QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)& status, sizeof(SERVICE_STATUS_PROCESS), &dwBytesNeeded) == 0) {
			Sleep(1000);
			continue;
		}

		DWORD pid = status.dwProcessId;
		if (pid == 0) {
			//MessageBoxA(NULL, "pid zero", "Watchdog:", 0);
			if (StartService(hService, 0, NULL) == 0) {
				//MessageBoxA(NULL, "start service zero", "Watchdog:", 0);
			}
			Sleep(1000);
			continue;
		}

		HANDLE hProcess = OpenProcess(SYNCHRONIZE, false, pid);
		if (hProcess == 0) {
			//MessageBoxA(NULL, "process handle zero", "Watchdog:", 0);
			Sleep(1000);
			continue;
		}
		
		//MessageBoxA(NULL, "starting wait", "Watchdog:", 0);
		WaitForSingleObject(hProcess, INFINITE);
		//MessageBoxA(NULL, "restarting service", "Watchdog:", 0);
	}

	CloseServiceHandle(hScm);
	CloseServiceHandle(hService);
	return 0;
}